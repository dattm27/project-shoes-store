<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!-- begin::Head -->

<head>
	<title>Admin | TopShoe</title>
	<th:block th:insert="admin/fragments/common :: global_css"></th:block>
</head>

<!-- end::Head -->

<!-- begin::Body -->

<body
	class="kt-quick-panel--right kt-demo-panel--right kt-offcanvas-panel--right kt-header--fixed kt-header-mobile--fixed kt-subheader--enabled kt-subheader--fixed kt-subheader--solid kt-aside--enabled kt-aside--fixed kt-page--loading">
	<!-- Modal -->
	<div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel"
		aria-hidden="true">
		<div class="modal-dialog  modal-dialog-scrollable" role="document">
			<div class="modal-content">
				<!-- Header của modal -->
				<div class="modal-header">
					<h5 class="modal-title" id="addProductModalLabel">Thêm Sản Phẩm Mới</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<!-- Nội dung của modal -->
				<div class="modal-body">
					<!-- Form nhập thông tin mới của sản phẩm -->
					<form id="addProductForm" action="/products/save" method="post" enctype="multipart/form-data">
						<div class="form-group">
							<label for="productName">Tên Sản Phẩm</label>
							<input type="text" class="form-control" id="productName" name="productName"
								placeholder="Nhập tên sản phẩm" required>
						</div>
						<div class="form-group">
							<label for="productPrice">Giá Sản Phẩm</label>
							<input type="number" class="form-control" id="productPrice" name="productPrice"
								placeholder="Nhập giá sản phẩm" required>
						</div>
						<div class="form-group">
							<label for="productVersion">Phiên Bản</label>
							<input type="text" class="form-control" id="productVersion" name="productVersion"
								placeholder="Nhập phiên bản sản phẩm" required>
						</div>
						<div class="form-group">
							<label for="productCategory">Danh Mục</label>
							<select class="form-control productCategory" id="productCategory" name="productCategory"
								required>
								<!-- Các option danh mục sẽ được thêm bằng JavaScript -->
							</select>
						</div>
						<div class="form-group">
							<label for="productBrand">Thương Hiệu</label>
							<select class="form-control productBrand" id="productBrand" name="productBrand" required>
								<!-- Các option thương hiệu sẽ được thêm bằng JavaScript -->
							</select>
						</div>
						<div class="form-group">
							<label for="productImages">Ảnh Sản Phẩm</label>
							<input type="file" class="form-control" id="productImages" name="productImages" multiple
								required>
						</div>
						<div class="form-group">
							<label for="productDescription">Mô tả Sản Phẩm</label>
							<textarea class="form-control" id="productDescription" name="productDescription" rows="3"
								placeholder="Nhập mô tả sản phẩm" required></textarea>
						</div>

						<!-- Thêm các trường nhập liệu cho số lượng đôi giày theo từng size -->

						<div class="form-group">
							<label>Số Lượng Đôi Giày Theo Kích Cỡ</label>
							<div id="sizeQuantityFields" class="container">
								<!-- Các trường input sẽ được thêm bằng JavaScript -->
							</div>
						</div>

				</div>
				<!-- Footer của modal -->
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
					<button type="submit" class="btn btn-primary">Lưu</button>
				</div>
				</form>
			</div>

		</div>
	</div>
	
	</div>
	<!--modal để chỉnh sửa thông tin sản phẩm-->
	<!-- Modal chỉnh sửa sản phẩm -->
	<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable" role="document">
			<div class="modal-content">
				<!-- Header của modal -->
				<div class="modal-header">
					<h5 class="modal-title" id="editProductModalLabel">Chỉnh Sửa Sản Phẩm</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<!-- Nội dung của modal -->
				<div class="modal-body">
					<!-- Form chỉnh sửa thông tin sản phẩm -->
					<form id="editProductForm" action="/products/update" method="post" enctype="multipart/form-data">
						<input type="hidden" id="editProductId" name="productId">
						<div class="form-group">
							<label for="editProductName">Tên Sản Phẩm</label>
							<input type="text" class="form-control" id="editProductName" name="productName"
								placeholder="Nhập tên sản phẩm" required>
						</div>
						<div class="form-group">
							<label for="editProductPrice">Giá Sản Phẩm</label>
							<input type="number" class="form-control" id="editProductPrice" name="productPrice"
								placeholder="Nhập giá sản phẩm" required>
						</div>
						<div class="form-group">
							<label for="editProductVersion">Phiên Bản</label>
							<input type="text" class="form-control" id="editProductVersion" name="productVersion"
								placeholder="Nhập phiên bản sản phẩm" required>
						</div>
						<div class="form-group">
							<label for="editProductCategory">Danh Mục</label>
							<select class="form-control productCategory" id="editProductCategory" name="productCategory"
								required>
								<!-- Các option danh mục sẽ được thêm bằng JavaScript -->
							</select>
						</div>
						<div class="form-group">
							<label for="editProductBrand">Thương Hiệu</label>
							<select class="form-control productBrand" id="editProductBrand" name="productBrand"
								required>
								<!-- Các option thương hiệu sẽ được thêm bằng JavaScript -->
							</select>
						</div>
						<!-- Hình ảnh hiện tại của sản phẩm -->
						<div class="form-group">
							<label>Hình ảnh hiện tại</label>
							<div id="currentProductImages" class="d-flex flex-wrap">
								<!-- Hình ảnh sẽ được thêm bằng JavaScript -->
							</div>
						</div>
						<div class="form-group">
							<label for="editProductImages">Ảnh Sản Phẩm</label>
							<input type="file" class="form-control" id="editProductImages" name="productImages"
								multiple>
						</div>
						<div class="form-group">
							<label for="editProductDescription">Mô tả Sản Phẩm</label>
							<textarea class="form-control" id="editProductDescription" name="productDescription"
								rows="3" placeholder="Nhập mô tả sản phẩm"></textarea>
						</div>
						<div class="form-group">
							<label>Số Lượng Đôi Giày Theo Kích Cỡ</label>
							<div class="row" id="editProductSizes">
								<!-- Các trường input cho size sẽ được thêm bằng JavaScript -->
							</div>
						</div>
						<!-- Footer của modal -->
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
							<button type="submit" class="btn btn-primary">Lưu</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


	<!-- begin:: Page -->

	<!-- begin:: Header Mobile -->
	<div th:replace="admin/fragments/header :: header_mobile"></div>
	<!-- end:: Header Mobile -->

	<div class="kt-grid kt-grid--hor kt-grid--root">
		<div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--ver kt-page">

			<!-- begin:: Aside -->
			<div th:replace="admin/fragments/sidebar"></div>
			<!-- end:: Aside -->

			<div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor kt-wrapper" id="kt_wrapper">

				<!-- begin:: Header -->
				<div th:replace="admin/fragments/header :: header"></div>
				<!-- end:: Header -->

				<div class="kt-content  kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor" id="kt_content">

					<!-- begin:: Content Head -->
					<div th:replace="admin/fragments/header :: sub_header"></div>
					<!-- end:: Content Head -->

					<!-- begin:: Content -->
					<div id="router-outlet"
						class="kt-container  kt-container--fluid  kt-grid__item kt-grid__item--fluid"></div>
					<!-- end:: Content -->
				</div>

				<!-- begin:: Footer -->
				<div th:replace="admin/fragments/footer"></div>
				<!-- end:: Footer -->
			</div>
		</div>
	</div>

	<!-- end:: Page -->

	<!-- begin::Quick Panel -->
	<div th:replace="admin/fragments/header :: quick_panel"></div>
	<!-- end::Quick Panel -->

	<!-- begin::Scrolltop -->
	<div id="kt_scrolltop" class="kt-scrolltop">
		<i class="fa fa-arrow-up"></i>
	</div>

	<!-- end::Scrolltop -->

	<th:block th:insert="admin/fragments/common :: global_script" type="text/javascript"></th:block>
	<script src="assets/js/template/layout.js" type="text/javascript"></script>
	<script>

		// Hàm JavaScript được gọi từ fragment khi nút "Thêm mới" được nhấp vào
		function openAddProductModal() {
			// Hiển thị modal
			$('#addProductModal').modal('show');
			  
	    
    

			
		}

		$(document).ready(function () {
			// Gọi API endpoint để lấy danh sách danh mục từ máy chủ khi mở modal
			$.ajax({
				url: '/category',
				type: 'GET',
				dataType: 'json',
				success: function (response) {
					//console.log(response);
					response.forEach(function (category) {
						//console.log(category)
						$('.productCategory').append('<option value="' + category.id + '">' + category.name + '</option>');
					});
				},
				error: function (xhr, status, error) {
					console.error('Error fetching categories:', error);
				}
			});

			// Gọi API endpoint để lấy danh sách thương hiệu từ máy chủ khi mở modal
			$.ajax({
				url: '/brands',
				type: 'GET',
				dataType: 'json',
				success: function (response) {
					response.forEach(function (brand) {
						$('.productBrand').append('<option value="' + brand.id + '">' + brand.name + '</option>');
					});
				},
				error: function (xhr, status, error) {
					console.error('Error fetching brands:', error);
				}
			});
		});

	</script>
	<!--thếm sản phẩm mới -->
	<script>
		$(document).ready(function () {
			// Bắt sự kiện khi form submit
			$('#addProductForm').submit(function (event) {
				// Ngăn chặn hành động mặc định của form (chặn submit lại trang)
				event.preventDefault();

				var form = $('#addProductForm')[0];
				var formData = new FormData(form);

				// Gửi AJAX POST request đến endpoint xử lý tạo mới sản phẩm
				$.ajax({
					type: 'POST',
					url: '/product/save',
					data: formData,
					processData: false, // prevent jQuery from automatically transforming the data into a query string
					contentType: false, // prevent jQuery from overriding the multipart content type
				})
					.done(function (data) {
						// Xử lý kết quả từ server nếu cần
						//console.log(data);
						// Đóng modal sau khi lưu thành công
						$('#addProductModal').modal('hide');
						// Nạp lại trang để cập nhật danh sách sản phẩm
						  // Reset form
				          $('#addProductForm')[0].reset();
				   
						//location.reload();
						getContent();
					})
					.fail(function (data) {
						// Xử lý lỗi nếu có
						console.error(data);
						// Hiển thị thông báo lỗi nếu cần
						alert('Đã xảy ra lỗi! Vui lòng thử lại sau.');
					});
			});
		});
	</script>
	<!--Script cho chỉnh sửa sản phẩm mới-->
	<script>// Hàm để mở modal chỉnh sửa sản phẩm và điền thông tin sản phẩm vào form
		var deletedImages = [];
		function editProduct(productId) {
			//reset danh sách ảnh sẽ xoá về trống
			deletedImages = [];
			// Gọi AJAX để lấy thông tin sản phẩm từ server
			$.ajax({
				url: '/product/detail/' + productId, // URL để lấy thông tin sản phẩm
				method: 'GET',
				success: function (product) {
					// Điền thông tin sản phẩm vào form trong modal
					$('#editProductId').val(product.id);
					$('#editProductName').val(product.name);
					$('#editProductPrice').val(product.price);
					$('#editProductVersion').val(product.version);
					$('#editProductCategory').val(product.category.id);
					$('#editProductBrand').val(product.brand.id);
					$('#editProductDescription').val(product.description);
					// Hiển thị hình ảnh hiện tại của sản phẩm
					var currentImagesContainer = $('#currentProductImages');
					currentImagesContainer.empty();
					product.images.forEach(function (image) {
						var imageElement = `
                   <div id="imageContainer_${image.id}" class="product-image" style="position: relative; margin: 10px;">
    <img src="/images/${image.imageUrl}" alt="${image.name}" class="img-thumbnail" style="max-width: 150px;">
    <button type="button" class="btn btn-danger btn-sm remove-image" style="position: absolute; top: 5px; right: 5px;" data-image-id="${image.id}" data-image-url="${image.imageUrl}">
        &times;
    </button>
</div>`;
						currentImagesContainer.append(imageElement);
					});


					// Hiển thị số lượng theo size hiện tại
					var sizesContainer = $('#editProductSizes');
					sizesContainer.empty();
					let i = 0;
					for (let size = 37; size <= 49; size++) {
						let s = product.sizes[i] || ''; // Lấy số lượng từ product.sizes hoặc để trống nếu không có
						let quantity = '';
						if (s != '' && size == s.size ){
							quantity = s.quantity;
							i++;
						}
						console.log(quantity);
						var sizeElement = `
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="editSize${size}">Size ${size}</label>
                                <input type="number" class="form-control size-input" id="editSize${size}" name="sizes[${size}]" value="${quantity}" placeholder="Số lượng">
                            </div>
                        </div>`;
						sizesContainer.append(sizeElement);
					}


					// Hiển thị modal chỉnh sửa sản phẩm
					$('#editProductModal').modal('show');
				},
				error: function (xhr, status, error) {
					console.error(xhr.responseText);
				}
			});
		}
		//Xử lý xoá hình ảnh
		$(document).on('click', '.remove-image', function () {
			// Lấy ID của hình ảnh cần xoá
			var imageId = $(this).data('image-id');
			//var imageUrl = $(this).data('image-url');

			// Thêm hình ảnh vào danh sách đã xoá
			deletedImages.push(imageId);
			// Log danh sách các hình ảnh đã xoá vào console
			console.log("Deleted Images:", deletedImages);

			// Ẩn phần tử chứa hình ảnh có ID tương ứng
			$(`#imageContainer_${imageId}`).hide();
		});
		//Xử lý sự kiện admin submit form chỉnh sửa thông tin sản phẩm
		$(document).ready(function () {
			// Bắt sự kiện khi form submit
			$('#editProductForm').submit(function (event) {
				// Ngăn chặn hành động mặc định của form (chặn submit lại trang)
				event.preventDefault();

				var form = $('#editProductForm')[0];
				const sizeInputs = form.querySelectorAll(".size-input");

				sizeInputs.forEach(input => {
					if (!input.value) {
						input.disabled = true;
					}
				});
				var formData = new FormData(form);
				
				

				// Thêm danh sách những ảnh đã xoá vào FormData
				deletedImages.forEach(function (image) {
					formData.append('deletedImages[]', JSON.stringify(image));
				});
				
				

				// Gửi AJAX POST request đến endpoint xử lý tạo mới sản phẩm
				$.ajax({
					type: 'POST',
					url: '/product/update',
					data: formData,
					processData: false, // prevent jQuery from automatically transforming the data into a query string
					contentType: false, // prevent jQuery from overriding the multipart content type
				})
					.done(function (data) {
						// Xử lý kết quả từ server nếu cần
						//console.log(data);
						// Đóng modal sau khi lưu thành công
						$('#editProductModal').modal('hide');
						// Nạp lại trang để cập nhật danh sách sản phẩm
						//location.reload();
						getContent();
					})
					.fail(function (data) {
						// Xử lý lỗi nếu có
						console.error(data);
						// Hiển thị thông báo lỗi nếu cần
						alert('Đã xảy ra lỗi! Vui lòng thử lại sau.');
					});
			});
		});
	</script>

	<script>
		// Tạo các trường input cho size và quantity theo hàng ngang
		document.addEventListener("DOMContentLoaded", function () {
			const sizes = [37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49];
			const sizeQuantityFields = document.getElementById("sizeQuantityFields");

			for (let i = 0; i < sizes.length; i += 3) {
				const row = document.createElement("div");
				row.classList.add("row");

				for (let j = 0; j < 3; j++) {
					if (i + j < sizes.length) {
						const col = document.createElement("div");
						col.classList.add("col-md-4");

						col.innerHTML = `
                        <div class="form-group">
                            <label for="size${sizes[i + j]}">Size ${sizes[i + j]}</label>
                            <input type="number" class="form-control size-input" id="size${sizes[i + j]}" name="sizes[${sizes[i + j]}]" placeholder="Số lượng">
                        </div>
                    `;
						row.appendChild(col);
					}
				}
				sizeQuantityFields.appendChild(row);
			}
		});

		document.getElementById("addProductForm").addEventListener("submit", function (event) {
			const form = event.target;
			const sizeInputs = form.querySelectorAll(".size-input");

			//sizeInputs.forEach(input => {
			//	if (!input.value) {
			//		input.disabled = true;
			//	}
			//
			});
		//});
	</script>
</body>

<!-- end::Body -->

</html>